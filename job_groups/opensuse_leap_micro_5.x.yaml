############################################################
#                         WARNING                          #
#                                                          #
#               This file is managed in GIT!               #
#  Any changes via the openQA WebUI will get overwritten!  #
#                                                          #
#    https://github.com/os-autoinst/opensuse-jobgroups     #
#         job_groups/opensuse_leap_micro_5.x.yaml          #
############################################################
---
.default_settings: &default_settings
  +BUILD: '%BUILD_ISO%_%BUILD_IMAGE%'  # To force having DVD and Images under the same group in openQA
  DESKTOP: 'textmode'

.dvd_settings: &dvd_settings
  <<: *default_settings
  YAML_SCHEDULE: 'schedule/sle-micro/dvd.yaml'

.dvd_autoyast_settings: &dvd_autoyast_settings
  <<: *default_settings
  YAML_SCHEDULE: 'schedule/sle-micro/autoyast.yaml'
  AUTOYAST: 'autoyast_opensuse/autoyast_leap-micro.xml.ep'
  AUTOYAST_PREPARE_PROFILE: '1'

.dvd_selinux_settings: &dvd_selinux_settings
  <<: *dvd_settings
  ENABLE_SELINUX: '1'

.dvd_qemu_settings: &dvd_qemu_settings
  <<: *dvd_settings
  QEMUCPU: 'host'
  PATTERNS: 'default,kvm'
  YAML_SCHEDULE: 'schedule/sle-micro/dvd_virt.yaml'

.image_settings: &image_settings
  <<: *default_settings
  BOOT_HDD_IMAGE: '1'
  HDD_2: 'ignition.qcow2'
  NUMDISKS: '2'
  HDDSIZEGB_1: '30'
  ENABLE_SELINUX: '1'
  FIRST_BOOT_CONFIG: 'combustion+ignition'

.image_container_settings: &image_container_settings
  <<: *image_settings
  SKIP_DOCKER_IMAGE_TESTS: '1'
  REGISTRY: 'registry.qe.suse.de:5000'
  CONTAINER_RUNTIME: 'podman'
  CONTAINER_IMAGE_VERSIONS: '15.4,15.4'

.selfinstall_settings: &selfinstall_settings
  <<: *default_settings
  NUMDISKS: '2'
  HDD_2: 'ignition.qcow2'  # openQA will create a qcow2 on the fly
  HDDSIZEGB_1: '30'
  QEMU_VIRTIO_RNG: '1'
  QEMUVGA: 'virtio'
  SELFINSTALL: '1'

.selfinstall_settings_aarch64: &selfinstall_settings_aarch64
  <<: *default_settings
  NUMDISKS: '2'
  HDD_2: 'ignition.qcow2'  # openQA will create a qcow2 on the fly
  HDDSIZEGB_1: '30'
  SELFINSTALL: '1'

.image_qemu_settings: &image_qemu_settings
  <<: *image_settings
  QEMUCPU: 'host'
  EXTRA: 'virtualization'

defaults:
  x86_64:
    machine: 64bit
    priority: 50
  aarch64:
    machine: aarch64
    priority: 50
    settings:
      QEMUCPUS: '2'

products:
  leap-micro-5.4-DVD-x86_64: &product_dvd
    distri: leap-micro
    flavor: DVD
    version: '5.4'
  leap-micro-5.4-DVD-aarch64:
    *product_dvd
  leap-micro-5.4-MicroOS-Image-SelfInstall-x86_64:
    distri: leap-micro
    flavor: Default-SelfInstall
    version: '5.4'
  leap-micro-5.4-MicroOS-Image-RT-SelfInstall-x86_64:
    distri: leap-micro
    flavor: Default-RT-SelfInstall
    version: '5.4'
  leap-micro-5.4-MicroOS-Image-x86_64: &product_image
    distri: leap-micro
    flavor: MicroOS-Image
    version: '5.4'
  leap-micro-5.4-MicroOS-Image-SelfInstall-aarch64:
    distri: leap-micro
    flavor: Default-SelfInstall
    version: '5.4'
  leap-micro-5.4-MicroOS-Image-aarch64:
    *product_image
  leap-micro-5.4-MicroOS-Image-RT-x86_64:
    distri: leap-micro
    flavor: MicroOS-Image-RT
    version: '5.4'

scenarios:
  x86_64:
    leap-micro-5.4-DVD-x86_64:
      - microos_installation_default:
          machine: [64bit, uefi]
          settings:
            <<: *dvd_settings
      - microos_installation_autoyast: &dvd_autoyast_test
          settings:
            <<: *dvd_autoyast_settings
      - microos_installation_selinux: &dvd_selinux_test
          settings:
            <<: *dvd_selinux_settings
      - microos_installation_virt:
          settings:
            <<: *dvd_qemu_settings
      - microos_ssh_installation_controller:
          settings:
            <<: *default_settings
            +BETA: ""
            EXTRABOOTPARAMS_BOOT_LOCAL: '3'
      - microos_ssh_installation_target:
          settings:
            <<: *default_settings
            MIRROR_HTTP: http://download.opensuse.org/distribution/leap-micro/%VERSION%/product/repo/Leap-Micro-%VERSION%-%ARCH%-Media/
            MIRROR_HTTPS: https://download.opensuse.org/distribution/leap-micro/%VERSION%/product/repo/Leap-Micro-%VERSION%-%ARCH%-Media/
            MIRROR_PREFIX: http://download.opensuse.org/distribution/leap-micro/5.4/product/repo/
            INSTALL_SOURCE: http
    leap-micro-5.4-MicroOS-Image-x86_64:
      - microos_image_default:
          machine: [64bit, uefi]
          settings:
            <<: *image_settings
      - microos_containers:
          settings:
            <<: *image_container_settings
      - microos_virtualization:
          settings:
            <<: *image_qemu_settings
    leap-micro-5.4-MicroOS-Image-RT-x86_64:
      - microos_image_default:
          settings:
            *image_settings
    leap-micro-5.4-MicroOS-Image-SelfInstall-x86_64:
      - microos_installation_default:
          machine: 64bit
          settings:
            <<: *selfinstall_settings
    leap-micro-5.4-MicroOS-Image-RT-SelfInstall-x86_64:
      - microos_installation_default:
          machine: 64bit
          settings:
            <<: *selfinstall_settings

  aarch64:
    leap-micro-5.4-MicroOS-Image-SelfInstall-aarch64:
      - microos_installation_default:
          settings:
            <<: *selfinstall_settings_aarch64
    leap-micro-5.4-MicroOS-Image-aarch64:
      - microos_image_default:
          settings:
            *image_settings
      - microos_containers:
          settings:
            <<: *image_container_settings
      - microos_virtualization:
          settings:
            <<: *image_qemu_settings
    leap-micro-5.4-DVD-aarch64:
      - microos_installation_default:
          settings:
            *dvd_settings
      - microos_installation_autoyast:
          *dvd_autoyast_test
      - microos_installation_selinux:
          *dvd_selinux_test
      - microos_installation_virt:
          settings:
            <<: *dvd_qemu_settings
